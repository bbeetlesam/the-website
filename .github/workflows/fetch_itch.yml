name: fetch itch.io data

on:
  schedule:
    - cron: "0 00 * * 0"
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  fetch-games:
    runs-on: ubuntu-latest

    steps:
      - name: checkout repo
        uses: actions/checkout@v4

      - name: fetch my itch.io (all games)
        env:
          ITCH_API_KEY: ${{ secrets.ITCH_API_KEY }}
        run: |
          mkdir -p public/data
          mkdir -p .dump
          curl -H "Authorization: Bearer $ITCH_API_KEY" \
            "https://itch.io/api/1/key/my-games" \
            -o .dump/itch-games-all.json

          # status log
          echo "fetched from itch.io and saved raw to .dump/itch-games-all.json"

      - name: filter (published only) and prettify json output
        run: |
          jq '.games |= map(select(.published == true))' .dump/itch-games-all.json > public/data/itch-games.json

          jq --sort-keys '.' public/data/itch-games.json > public/data/itch-games-pretty.json
          mv public/data/itch-games-pretty.json public/data/itch-games.json

          # status log
          echo "filtered and prettified, saved to public/data/itch-games.json"

      - name: commit and push updated data
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add public/data/itch-games.json
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "auto update itch.io games data at $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            git push
          fi